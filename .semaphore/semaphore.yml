version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: ValidatePR
    skip:
      when: branch = 'master'
    task:
      jobs:
        - name: packer validate
          commands:
            - |-
              if [ "$SEMAPHORE_GIT_REF_TYPE" = "pull-request" ]; then
                wget https://releases.hashicorp.com/packer/1.4.5/packer_1.4.5_linux_amd64.zip && unzip packer_1.4.5_linux_amd64.zip
                sudo mv packer /usr/local/bin && sudo chmod +x /usr/local/bin/packer
                checkout
                packer validate ami.json
              fi
    dependencies: []
  - name: Build AMI
    skip:
      when: branch != 'master'
    task:
      secrets:
        - name: AWS
      jobs:
        - name: packer build
          commands:
            - checkout
            - >-
              wget
              https://releases.hashicorp.com/packer/1.4.5/packer_1.4.5_linux_amd64.zip
              && unzip packer_1.4.5_linux_amd64.zip
            - >-
              sudo mv packer /usr/local/bin && sudo chmod +x
              /usr/local/bin/packer
            - >-
              packer build -var "aws_access_key=${AWS_ACCESS_KEY_ID}" -var
              "aws_secret_key=${AWS_SECRET_ACCESS_KEY}" ami.json
            - artifact push project manifest.json --force
    dependencies: []
  - name: Test AMI
    task:
      secrets:
        - name: AWS
        - name: packer-CI
      env_vars:
        - name: AWS_REGION
          value: us-east-1
        - name: KEY_PAIR
          value: packer-CI
        - name: SG
          value: sg-0800e2fd2d7ac3912
        - name: INSTANCE_TYPE
          value: t2.micro
        - name: SSH_USER
          value: ubuntu
      jobs:
        - name: test packer ami
          commands:
            - checkout
            - sudo apt update -y && sudo apt install awscli -y
            - gem install ami_spec --no-ri --no-rdoc
            - chmod 400 ~/.ssh/packer-CI.pem
            - artifact pull project manifest.json
            - >-
              AMI_ID=$(cat manifest.json | jq -r '.builds[].artifact_id' | sed -e
              "s/${AWS_REGION}://g")
            - >-
              ami_spec \
              --specs=spec \ 
              --role=web_server \
              --key-name=${KEY_PAIR} \
              --key-file=~/.ssh/packer-CI.pem \
              --ssh-user=${SSH_USER} \
              --aws-region=${AWS_REGION} \
              --ami=${AMI_ID} \
              --aws-security-groups=${SG} \
              --aws-public-ip                
            - >-
              aws ec2 deregister-image --image-id ${AMI_ID} --region
              ${AWS_REGION}
    dependencies:
      - Build AMI
