version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: ValidatePR
    task:
      jobs:
        - name: packer validate
          commands:
            - |-
              if [ "$SEMAPHORE_GIT_REF_TYPE" = "pull-request" ]; then
                wget https://releases.hashicorp.com/packer/1.4.5/packer_1.4.5_linux_amd64.zip && unzip packer_1.4.5_linux_amd64.zip
                sudo mv packer /usr/local/bin && sudo chmod +x /usr/local/bin/packer
                checkout
                packer validate ami.json
              fi
  - name: Build AMI
    skip:
      when: branch != 'master'
    task:
      secrets:
        - name: AWS
      jobs:
        - name: packer build
          commands:
            - checkout
            - >-
              wget
              https://releases.hashicorp.com/packer/1.4.5/packer_1.4.5_linux_amd64.zip
              && unzip packer_1.4.5_linux_amd64.zip
            - >-
              sudo mv packer /usr/local/bin && sudo chmod +x
              /usr/local/bin/packer
            - >-
              packer build -var "aws_access_key=${AWS_ACCESS_KEY_ID}" -var
              "aws_secret_key=${AWS_SECRET_ACCESS_KEY}" ami.json
  - name: Test AMI
    task:
      secrets:
        - name: AWS
      env_vars:
        - name: AWS_REGION
          value: us-east-1
      prologue:
        commands:
          - '# aws ec2 terminate-instances '
          - '# aws ec2 deregister-image --image-id ami_id'
      jobs:
        - name: test packer ami
          commands:
            - >-
              # aws ec2 run-instances --image-id ami-xxxxxxxx --count 1
              --instance-type t2.micro --key-name MyKeyPair
